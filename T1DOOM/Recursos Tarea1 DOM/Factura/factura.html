<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Factura</title>
    <meta charset="UTF-8">    
    <link href="bootstrap.css" rel="stylesheet">
    <style>
        body {
            padding: 10px;
            background-color: blue height 100%
        }

        th {
            background-color: palegreen
        }

        izd {
            text-align: right
        }

        .container {
            background-color: darkseagreen
        }

        select,
        input:hover {
            background-color: palegreen
        }

        select,
        input:active {
            background-color: darkseagreen
        }

        tr {
            line-height: 10px;
        }

        td .trborrar {
            text-align: right;
        }

        .produc {
            line-height: 20px;
        }

        .rojo {
            background-color: maroon;
            color: white;
            padding: 5px;
            border: black 0px solid;
            font-weight: 600;

        }

        .verde {
            background-color: seagreen;
            color: white;
            font-weight: 600;
        }

        #alta {
            position: fixed;
            background-color: white;
            top: 25%;
            left: 50%;
            padding: 20px;
            border: black 4px solid;
            display: none
        }
    </style>
</head>

<body>
    <div class="contenedor">
        <h1><img onclick="mostrar()                " src="carrito2.jpg" width="75">Carrito de la compra</h1>
        <div id="alta">
            <h1>Alta de articulo : </h1>
            <p>Producto&nbsp;<input type="text" id="producto2"></p>
            <p>Precio&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="precio2"></p>
            <p><button class="verde" type="button"  onclick="AltaProducto()">Añadir Producto</button></p>
            <p onclick="mostrar()" style="text-align: right;color:red"><b>X</b></p>
        </div>
        <div style="margin:10px">
            <pre>     Producto                   Precio                    Unidades              Importe</pre>
               <select name="factura" id="factura">
            <option selected="selected">Seleccione una factura</option></select>
            <select name="producto" id="producto">
            <option selected="selected">Seleccione un producto...</option></select>
            <input type="text" id="precio" readonly>
            <input type="number" id="unidades" min="1" value="1">
            <input type="text" id="importe" readonly>
            <button class="verde" type="button" onclick="AñadirProductoTabla()">Añadir a la cesta</button>
                        

        </div>
        <hr>
        <div class="container">
            <div class="row">
                <table class="table" id="tabla" border="1">
                    <thead class="thead-dark">
                        <tr class="thead-dark">
                            <th class="thead-dark" id="izd">Producto</th>
                            <th class="thead-dark">Precio</th>
                            <th class="thead-dark">Unidades</th>
                            <th class="thead-dark">Importe</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                    <tfoot id="tfoot"><tr><td></td><td></td><td>Total</td><td align="right">0.00</td><td style="width:15px"></td></tr></tfoot>
                </table>
                <div class="form-group">
                    <button type="button" class="btn btn-danger" onclick="borrarCesta()">Borrar cesta</button>
                    <button type="button" class="btn btn-success" onclick="crearFactura()">Crear Factura</button>
                    <button type="button" class="btn btn-success" onclick="ModificarFactura()">Modificar Factura</button>
                    <button type="button" class="btn btn-success" onclick="BorrarFactura()">Borrar Factura</button>
                </div>

            </div>
        </div>
    </div>

<script type="module">
 
 import Producto from './Producto.js'
 import Carrito from './Carrito.js'
 const { leerproductos, guardarproducto, guardarFactura, leerFacturas, leerFactura, modificarFactura, borrarFactura } = require('./Functions.js');

        // Cargar productos al inicio
        function cargarProductosIniciales() {
            try {
                const productos = leerproductos();
                const select = document.getElementById("producto");
                
                productos.forEach(producto => {
                    let option = document.createElement("option");
                    option.text = producto.Nombre;
                    option.value = producto.Nombre;
                    option.setAttribute("data-precio", producto.Precio);
                    select.add(option);
                });
            } catch (error) {
                console.error("Error al cargar productos:", error);
            }
        }

        // Función para cargar las facturas en el select
        function cargarFacturasIniciales() {
            try {
                const facturas = leerFacturas();
                const select = document.getElementById("factura");
                
                // Limpiar opciones existentes excepto la primera
                while(select.options.length > 1) {
                    select.remove(1);
                }
                
                facturas.forEach(nombreFactura => {
                    let option = document.createElement("option");
                    option.text = nombreFactura;
                    option.value = nombreFactura;
                    select.add(option);
                });
            } catch (error) {
                console.error("Error al cargar facturas:", error);
            }
        }

        // Función para cargar una factura seleccionada
        function cargarFactura(nombreFactura) {
            try {
                const factura = leerFactura(nombreFactura);
                if (!factura) return;

                // Limpiar la tabla actual
                borrarCesta();

                // Cargar los productos de la factura
                factura.productos.forEach(prod => {
                    let tabla = document.getElementById("tabla").getElementsByTagName('tbody')[0];
                    let newRow = tabla.insertRow();
                    let celda1 = newRow.insertCell(0);
                    let celda2 = newRow.insertCell(1);
                    let celda3 = newRow.insertCell(2);
                    let celda4 = newRow.insertCell(3);
                    let celda5 = newRow.insertCell(4);

                    celda1.innerHTML = prod.nombre;
                    celda2.innerHTML = prod.precio.toFixed(2);
                    celda3.innerHTML = prod.unidades;
                    celda4.innerHTML = prod.importe.toFixed(2);
                    celda5.innerHTML = '<button class="rojo" type="button" onclick="borrarProductoTabla()">X</button>';
                });

                CalcularImporteTabla();
            } catch (error) {
                console.error("Error al cargar la factura:", error);
            }
        }

        // Agregar evento para cambio en el select de facturas
        document.getElementById("factura").addEventListener("change", function() {
            const selectedFactura = this.value;
            if (selectedFactura !== "Seleccione una factura") {
                cargarFactura(selectedFactura);
            }
        });

        // Cargar productos y facturas cuando se carga la página
        window.addEventListener('load', () => {
            cargarProductosIniciales();
            cargarFacturasIniciales();
        });

        function guardarProductos(productos) {
            // Convierte un array de objetos Producto a la forma esperada y guarda cada uno
            const productosToSave = productos.map(producto => ({
                Nombre: producto.getNombre(),
                Precio: producto.getPrecio()
            }));
            try {
                productosToSave.forEach(p => {
                    // llamar a la función que escribe en el JSON
                    guardarproducto({ nombre: p.Nombre, precio: p.Precio });
                });
            } catch (err) {
                console.error('Error al guardar productos:', err);
            }
        }


        // Muestra y oculta la division de alta de productos
        function mostrar() {
            var e = document.getElementById("alta"); //recoge todo el elemento alta
            if (e.style.display == "block") { //si se ve
                e.style.display = "none" //que no se vea
            } else { //si no
                e.style.display = "block"; //que se vea
            }

        }
        window.mostrar = mostrar;
        window.AltaProducto = AltaProducto;
        window.AñadirProductoTabla = AñadirProductoTabla;
        window.borrarProductoTabla = borrarProductoTabla;
        window.borrarCesta = borrarCesta;
        window.guardarProductos = guardarProductos;
function AltaProducto() {
         let nombre = document.getElementById("producto2").value;
         if (!nombre) {
             alert('Por favor, ingrese el nombre del producto');
             return;
         }
         let precio = parseFloat(document.getElementById("precio2").value);
         if (isNaN(precio) || precio <= 0) {
             alert('Por favor, ingrese un precio válido');
             return;
         }

         let producto = new Producto(nombre, precio, "");
         let carrito = new Carrito();
         carrito.agregarProducto(producto);

         // Guardar/Actualizar el producto en el JSON
         guardarProductos([producto]);

         // Actualizar o agregar el producto en el select
         actualizarProductoEnSelect(producto);

         // Limpiar los campos del formulario
         document.getElementById("producto2").value = "";
         document.getElementById("precio2").value = "";

         // Cerrar el formulario
         mostrar();
    }

function actualizarProductoEnSelect(Producto) {
    let OpSelect = document.getElementById("producto");
    let nombreProducto = Producto.getNombre().trim(); // Eliminar espacios al inicio y final
    let encontrado = false;

    // Primero, eliminar cualquier opción duplicada
    for (let i = OpSelect.options.length - 1; i >= 1; i--) {
        for (let j = i - 1; j >= 1; j--) {
            if (OpSelect.options[i].value.toLowerCase().trim() === OpSelect.options[j].value.toLowerCase().trim()) {
                OpSelect.remove(i);
                break;
            }
        }
    }

    // Buscar si el producto ya existe en el select
    for (let i = 0; i < OpSelect.options.length; i++) {
        if (OpSelect.options[i].value.toLowerCase().trim() === nombreProducto.toLowerCase()) {
            // Actualizar el precio y el texto del producto existente
            OpSelect.options[i].setAttribute("data-precio", Producto.getPrecio());
            OpSelect.options[i].text = nombreProducto; // Asegurar que el texto esté limpio
            OpSelect.options[i].value = nombreProducto; // Asegurar que el valor esté limpio
            encontrado = true;
            alert('Producto actualizado correctamente');
            break;
        }
    }

    // Si no se encontró el producto, añadirlo como nuevo
    if (!encontrado) {
        let Op = document.createElement("option");
        Op.text = nombreProducto;
        Op.value = nombreProducto;
        Op.setAttribute("data-precio", Producto.getPrecio());
        OpSelect.add(Op);
        alert('Producto añadido correctamente');
    }

    // Recargar los productos para asegurar que todo está sincronizado
    cargarProductosIniciales();
}
function ImportTotal(){
   let precio = document.getElementById("precio").value;
    let unidades = document.getElementById("unidades").value;
    
    // Asegurarse de que unidades sea al menos 1
    if (!unidades || unidades < 1) {
        unidades = 1;
        document.getElementById("unidades").value = 1;
    }
    
    let importe = parseFloat(precio) * parseInt(unidades);
    let importatotal = document.getElementById("importe");
    importatotal.value = importe.toFixed(2);
}
// calculo de importe
 const precioInput = document.getElementById("precio");
 const unidadesInput = document.getElementById("unidades");
 const importeInput = document.getElementById("importe");
 const selectProducto = document.getElementById("producto");
    precioInput.addEventListener("input", ImportTotal);
    unidadesInput.addEventListener("input", ImportTotal);
    selectProducto.addEventListener("change", function() {
        const selectedOption = selectProducto.options[selectProducto.selectedIndex];
        const precio = selectedOption.getAttribute("data-precio");
        precioInput.value = precio;
        ImportTotal();}
    );

    function AñadirProductoTabla(){
        let tabla = document.getElementById("tabla").getElementsByTagName('tbody')[0];
        let nombreProducto = document.getElementById("producto").value;
        let precio = parseFloat(document.getElementById("precio").value);
        let nuevasUnidades = parseInt(document.getElementById("unidades").value);
        let encontrado = false;

        // Buscar si el producto ya existe en la tabla
        for (let i = 0; i < tabla.rows.length; i++) {
            if (tabla.rows[i].cells[0].innerHTML === nombreProducto) {
                // El producto ya existe, sumar las unidades
                let unidadesActuales = parseInt(tabla.rows[i].cells[2].innerHTML);
                let unidadesTotales = unidadesActuales + nuevasUnidades;
                tabla.rows[i].cells[2].innerHTML = unidadesTotales;
                // Actualizar el importe
                let importeTotal = (precio * unidadesTotales).toFixed(2);
                tabla.rows[i].cells[3].innerHTML = importeTotal;
                encontrado = true;
                break;
            }
        }

        // Si el producto no existe en la tabla, crear una nueva fila
        if (!encontrado) {
            let newRow = tabla.insertRow();
            let celda1 = newRow.insertCell(0);
            let celda2 = newRow.insertCell(1);
            let celda3 = newRow.insertCell(2);
            let celda4 = newRow.insertCell(3);
            let celda5 = newRow.insertCell(4);

            celda1.innerHTML = nombreProducto;
            celda2.innerHTML = precio.toFixed(2);
            celda3.innerHTML = nuevasUnidades;
            celda4.innerHTML = document.getElementById("importe").value;
            celda5.innerHTML = '<button class="rojo" type="button" onclick="borrarProductoTabla()">X</button>';
        }

        CalcularImporteTabla();

        // Resetear el campo de unidades a 1
        document.getElementById("unidades").value = 1;
        ImportTotal(); // Actualizar el importe mostrado
    }
    function CalcularImporteTabla(){
        let tabla = document.getElementById("tabla").getElementsByTagName('tbody')[0];
        let total = document.getElementById("tfoot").rows[0].cells[3].innerHTML = 0;

        for (let i = 0; i < tabla.rows.length; i++) {
            let importe = parseFloat(tabla.rows[i].cells[3].innerHTML);
            total += importe;
        }
        let tfoot = document.getElementById("tfoot");
        tfoot.rows[0].cells[3].innerHTML = total.toFixed(2);
    }

    function borrarProductoTabla(){
        let tabla = document.getElementById("tabla").getElementsByTagName('tbody')[0];
        tabla.deleteRow(event.target.parentNode.parentNode.rowIndex - 1);
        CalcularImporteTabla()
    }

function borrarCesta(){
    let tabla = document.getElementById("tabla").getElementsByTagName('tbody')[0];
    while(tabla.rows.length > 0){
        tabla.deleteRow(0);
    }
    CalcularImporteTabla()
}

// Función para crear y guardar la factura
function crearFactura() {
    try {
        // Verificar si hay productos en la tabla
        const tabla = document.getElementById("tabla").getElementsByTagName('tbody')[0];
        if (tabla.rows.length === 0) {
            alert('No hay productos en la cesta para crear la factura');
            return;
        }

        // Obtener la fecha y hora actual para el nombre del archivo
        const fecha = new Date();
        const fechaStr = fecha.getFullYear() +
                        ('0' + (fecha.getMonth() + 1)).slice(-2) +
                        ('0' + fecha.getDate()).slice(-2) + '_' +
                        ('0' + fecha.getHours()).slice(-2) +
                        ('0' + fecha.getMinutes()).slice(-2) +
                        ('0' + fecha.getSeconds()).slice(-2);
        
        // Obtener los productos de la tabla
        const productos = [];
        let totalCalculado = 0;
        
        for (let i = 0; i < tabla.rows.length; i++) {
            const precio = parseFloat(tabla.rows[i].cells[1].innerHTML);
            const unidades = parseInt(tabla.rows[i].cells[2].innerHTML);
            const importe = precio * unidades; // Calculamos el importe nuevamente para asegurar precisión
            
            productos.push({
                nombre: tabla.rows[i].cells[0].innerHTML,
                precio: precio,
                unidades: unidades,
                importe: importe
            });
            
            totalCalculado += importe;
        }
        
        // Crear el objeto factura
        const factura = {
            fecha: fecha.toISOString(),
            productos: productos,
            total: totalCalculado
        };
        
        // Guardar la factura
        const nombreArchivo = `Factura_${fechaStr}.json`;
        if (guardarFactura(nombreArchivo, factura)) {
            // Limpiar la tabla
            borrarCesta();
            
            // Mostrar mensaje de éxito
            alert('Factura guardada correctamente como: ' + nombreArchivo);
        } else {
            throw new Error('Error al guardar la factura');
        }
        
    } catch (error) {
        console.error('Error al crear la factura:', error);
        alert('Error al crear la factura: ' + error.message);
    }
}

// Función para modificar una factura existente
function ModificarFactura() {
    try {
        // Obtener la factura seleccionada
        const selectFactura = document.getElementById("factura");
        const nombreFactura = selectFactura.value;

        if (nombreFactura === "Seleccione una factura") {
            alert('Por favor, seleccione una factura para modificar');
            return;
        }

        // Verificar si hay productos en la tabla
        const tabla = document.getElementById("tabla").getElementsByTagName('tbody')[0];
        if (tabla.rows.length === 0) {
            alert('No hay productos en la cesta para modificar la factura');
            return;
        }

        // Obtener los productos actualizados de la tabla
        const productos = [];
        let totalCalculado = 0;
        
        for (let i = 0; i < tabla.rows.length; i++) {
            const precio = parseFloat(tabla.rows[i].cells[1].innerHTML);
            const unidades = parseInt(tabla.rows[i].cells[2].innerHTML);
            const importe = precio * unidades;
            
            productos.push({
                nombre: tabla.rows[i].cells[0].innerHTML,
                precio: precio,
                unidades: unidades,
                importe: importe
            });
            
            totalCalculado += importe;
        }
        
        // Crear el objeto factura actualizado
        const factura = {
            fecha: new Date().toISOString(), // Actualizamos la fecha de modificación
            productos: productos,
            total: totalCalculado
        };
        
        // Modificar la factura
        if (modificarFactura(nombreFactura, factura)) {
            alert('Factura modificada correctamente');
            // Recargar la lista de facturas
            cargarFacturasIniciales();
        } else {
            throw new Error('Error al modificar la factura');
        }
        
    } catch (error) {
        console.error('Error al modificar la factura:', error);
        alert('Error al modificar la factura: ' + error.message);
    }
}

// Función para borrar una factura
function BorrarFactura() {
    try {
        // Obtener la factura seleccionada
        const selectFactura = document.getElementById("factura");
        const nombreFactura = selectFactura.value;

        if (nombreFactura === "Seleccione una factura") {
            alert('Por favor, seleccione una factura para borrar');
            return;
        }

        // Confirmar antes de borrar
        if (!confirm('¿Está seguro de que desea borrar la factura ' + nombreFactura + '?')) {
            return;
        }

        // Borrar la factura
        if (borrarFactura(nombreFactura)) {
            alert('Factura borrada correctamente');
            // Limpiar la tabla
            borrarCesta();
            // Recargar la lista de facturas
            cargarFacturasIniciales();
            // Resetear el select de facturas
            selectFactura.value = "Seleccione una factura";
        } else {
            throw new Error('Error al borrar la factura');
        }
        
    } catch (error) {
        console.error('Error al borrar la factura:', error);
        alert('Error al borrar la factura: ' + error.message);
    }
}

// Exportar las funciones al objeto window
window.crearFactura = crearFactura;
window.ModificarFactura = ModificarFactura;
window.BorrarFactura = BorrarFactura;
</script>
</body></html>